#!/bin/sh
#
# XXX: remove this, once the debugging is done
if [ -e /run/mnt/ubuntu-seed ]; then
    LOG=/run/mnt/ubuntu-seed/fixrtc-run.log
else
    LOG=/run/fixrtc-run.log
fi
exec >> "$LOG"
exec 2>&1

printf "%s\n" "Starting $(date)"
TIMESYNC_CLOCK=/var/lib/systemd/timesync/clock
SELF=$(readlink -f "$0")

# get the mtime of this script
NOW="$(date +'%s')"
# Note that we cannot just "stat /proc/self/exe" here, this resolves to the
# /usr/bin/stat binary
MTIME_SELF="$(stat -L "$SELF" -c '%Y')"

# get the mtime from timesyncd that is written every 60s
MTIME_TIMESYNC_CLOCK=0
if [ -e $TIMESYNC_CLOCK ]; then
    MTIME_TIMESYNC_CLOCK="$(stat -L $TIMESYNC_CLOCK -c '%Y')"
fi

# find the highest MTIME from the two filesystem references
if [ "$MTIME_TIMESYNC_CLOCK" -gt "$MTIME_SELF" ]; then
    MTIME="$MTIME_TIMESYNC_CLOCK"
else
    MTIME="$MTIME_SELF"
fi

# set to the highest mtime found if the current time is too old
if [ "$NOW" -lt "$MTIME" ]; then
   date -s @"$MTIME"
fi
