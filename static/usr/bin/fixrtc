#!/bin/sh

TIMESYNC_CLOCK=/var/lib/systemd/timesync/clock

# get the mtime of this script
NOW="$(date +'%s')"
MTIME_SELF="$(stat -L "/proc/self/exe" -c '%Y')"

# get the mtime from timesyncd that is written every 60s
MTIME_TIMESYNC_CLOCK=0
if [ -e $TIMESYNC_CLOCK ]; then
    MTIME_TIMESYNC_CLOCK="$(stat -L $TIMESYNC_CLOCK -c '%Y')"
fi

# find the highest MTIME from the two filesystem references
if [ "$MTIME_TIMESYNC_CLOCK" -gt "$MTIME_SELF" ]; then
    MTIME="$MTIME_TIMESYNC_CLOCK"
else
    MTIME="$MTIME_SELF"
fi

# set to the highest mtime found if the current time is too old
if [ "$NOW" -lt "$MTIME" ]; then
   date -s @"$MTIME"
fi
