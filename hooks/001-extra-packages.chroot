#!/bin/sh

set -eux

export DEBIAN_FRONTEND=noninteractive

# TODO: work with foundation to not have PROPOSED=1 when building the
#       bionic-base tarfiles. Right now we still get some packages from
#       proposed presumably if they are part of the initial debootstrap.
#
# ensure we don't use proposed for new installs
rm -f /etc/apt/sources.list.d/proposed.list


# ensure we have /proc or systemd will fail
mount -t proc proc /proc
trap 'umount /proc' EXIT

# systemd postinst needs this
mkdir -p /var/log/journal

# We need to install first the certificates as apt will need them for https to lp
apt update
apt install --no-install-recommends -y ca-certificates

# shellcheck disable=SC1091
CODENAME=$(. /etc/os-release; echo "$UBUNTU_CODENAME")
# enable the ucdev PPA with additional packages to build bases
echo "deb https://ppa.launchpadcontent.net/ucdev/base-ppa/ubuntu/ $CODENAME main" \
     > /etc/apt/sources.list.d/ubuntu-image.list

cat >/etc/apt/trusted.gpg.d/ucdev-base-ppa.asc <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBGLW9dwBEAC7UJatAWOrUgfJlElkTUfmjL6JCTONYGy1Qzrw65YgzjdJGvXQ
iuOZyeX3lGjBrihbH7hQvlf2Cyo6E7DA/PLUMVAUMfc52U9RH2ovejZ25BonyL/e
XArTBRNWcjOgZXsO2aAcQZ7Tn1hYbjYv8zGmurk1vbQYKd/LlZsdrAkq2lmVOFPq
MTDLfa8vIhlfbr7uQlcB6uBehLYUUoTW3nV9HiA6fDTr86N2cQjhP7zxTZHxn52p
/ba0um5Hlg814l80S3ALaPQzqnpPPix0yzT7P2JfoIXKof4Lm28I2txK3fATeFzI
AQpqZqsCyRxyNJcN3AW9ma/dz7Orgq0y0q0xzTtvHq3+MuVAwFRhk9wyOZNPU9a6
OnavN9WF9hZywyf5/5OHMdKUendsi/k87B/K5fFUSHpukJyrZira02jkX8jwREkh
T2zUZrume63fRXP7zXSZ1nKPfsJY7k8NhHsxOc8aF6xvm624IpQTZc3g+xT+L5o7
QVuHIV2CxxWdSAQ0QdNAeCT/hIsYbeu+6AKPNSqMzobSIC01zZ8oN1c8veMkFPkh
tWuXoCRxtMF6rNh9PMXQLLUqiC6E6N5h5uSvQYIF4gGa3zw3B3HxJBD4/AoVkr//
/BVXH0fLlDuxelm9CoJPoFGoOuRyKDbgzBbO9pHpp9BDFQqpvzKal6JTeQARAQAB
tBdMYXVuY2hwYWQgUFBBIGZvciB1Y2RldokCTgQTAQoAOBYhBJ2nQrQmt92ewjMj
kwOpzTcHpv33BQJi1vXcAhsDBQsJCAcCBhUKCQgLAgQWAgMBAh4BAheAAAoJEAOp
zTcHpv33MbkP/2MIfnk3i36DmzIiVPwWhhEMrc7hE+SNGiawlO/uJngK48SXQgyN
Z7XbN27uId/HT11mHArl4aeG/iFScJKUCvQNAQzN3qHZ+hbiWQ/E9AedBNg+W5ef
60vfYhs5FFYRAsZmt0kab7r96LH0r5qiQbO9RdlGu2YazcTXInh9vG0/IBuYGwBO
+b+z6Y4rsOUh/20xUIvkRIXIZr7xNjGe6rBHjdQLeyyZ5y1m68OVXh1yhcetO2EV
KjMcYBu+EdYc7BKHvlyaelKtYEMd/EHoA/7DprcKMziLo+V0FUdhPZBEtra1RUFn
72/orlz+Doghs/wVSyXQi2txeIArF4cJJq84SyBMH/6VLm1osR4q0ek1e3HFWGR6
tSI7ZFO2ZCPGc456osWlt0aX1hYiIFN8oRmhCsPsSADSZndt1uCfKCOZBn78p4E1
lUSNqIRta827YdPU57AdzBja915X7U7clHn9i/3Kz/f6egRhkuy8mItbrZHO3jGp
RxHKbIBT9oXnt+Zj2Yp3Kcu9Lf3ebsEbBdPh0gZlM1QKh0BHRoOIc7Xw37KMtS2m
opKDBUugNPIcdTranx/trc23fYOc+ObPlHJ8q22wNoF7bH4jCIohpDzy0ar3H8vV
jdVw2j6diVag+TBwXXX/pBCBMFvUHJph5afKSfnrIuDk6yzCV8TaGAer
=L0hK
-----END PGP PUBLIC KEY BLOCK-----
EOF

# temporary
echo "deb http://ppa.launchpadcontent.net/valentin.david/test-ucdev-base/ubuntu $CODENAME main" \
      > /etc/apt/sources.list.d/valentin.david-test-ucdev-base.list

cat >/etc/apt/trusted.gpg.d/valentin.david-test-ucdev-base.asc <<'EOF'
-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: Hostname: 
Version: Hockeypuck 2.2

xsFNBGFxbb4BEAC1Aq399YDvc0QqmkB6rwCcTVT+0AHpxBuMifntYBrigUwfPHa9
QHoNcXjr7AvStekGCzS+2fypJpGnfn1HSkOFQRnIG9giKZoK6MMuOEpCX5GNb0Qc
AlUo5qvQJaPEZBrSX/VbZt0KFeTdIzqVFlygAIeQ1Qhsk5wy4FDADT5n/8a9bO/C
yaTJ99cKGzrQIUvG6ygC5YRoZdqaBY3RFQMnIOVSDDOG0NNXK8ircn1O3bowT9TP
5x7cOTvDsBwcevBiuxTJ6GxtpedBvq3Da3xccLstd5tn7GZCpqOYJoEijDIdHKhw
7rFTXPgSnicpceRXl37uaTT8EAF5iQ4FwI2lGcOCkR/Z1YtJsZyV6epIspW1Ri29
HIMjye1QnDIXmv4sQk/pUuj4KJFtvw/gLZaeuMqDKNsqAckQ6lAE/c0byegD3Klt
uVJrCVGKm2vDRDcy+fGCfEUUlpu4v+U9XsZFUx4c3FQe1QHq0IoGkGXLftjbt6HL
SZWDShMoQdT3zjqp2+AWLPpfOiXtqFS5VAl9TQlXKrBWrGhCWbzJt+CTd/xyxfJN
QwxW76xMmfIQEQGVfo1vOYoCqo/kwVlT9l9m0XDMEliKd5t4vQCxdXaHqWmI0O4I
LZ/eEF4K+b9PbNEa18KygubQTQ2RcZwJFdS6vt/KixiAr4Zy5CSFD/7mFQARAQAB
zSBMYXVuY2hwYWQgUFBBIGZvciBWYWxlbnRpbiBEYXZpZMLBjgQTAQoAOBYhBMBY
MvM8gZfcb+Ooq2iWhz8BI/cFBQJhcW2+AhsDBQsJCAcCBhUKCQgLAgQWAgMBAh4B
AheAAAoJEGiWhz8BI/cF2ggP/3AOgPW1cbX7VNcKl/wgg8ALH82y9fnQsYWUFgFk
B5H4LLARAovi14JvycCvCnCREJ/c8+W/BfMbaNcUvtvIXKjqcS6iQfhwk3OHkL9R
W6o6JAu6ESvgFnnM60LlDJOZBHOWDMbWORH0ycQ3uwrmE9ua1CaHL++QlF4cS70x
iDye4YSxHcwvUmvrU1Mi9enLnQg05B8+KLI9wQQRM6zoEu+IEoYF3NLFOHqAlAQn
qIc/dsdFhYtXRvAGTXqY6KXdw6lDAKIJMquuEPdm/HMxiCVxP/qH7jXg6s8fCeNg
AxakBJYr/pAfStYLdCTzyiM7jTjGUIpnQ20atjGQNN877FJsZ5B6Vq9b9gdKzvPN
wgwAkU0seFSRVOUUyu5bGNd0YSKq2x8tNwPf1r8qDFy0anbh9iLpGqhc/4wQ8qAd
o6dMdoBBCrUW5mT0nZpMAvNE4AwqPDFYj4S5fKjtYFAWhT9OkukYJo41STjTJOgx
sdUPPley+qFZBK7narpSywGzCPFUBjWMEex3Ymh9bz5yNBy921uaTEChZfNSXDM5
Lrn0I0t1vGdzczUMTppMnmvYlwKbtiBufFz8e60AO+3pjHrD2KRBTk5EBthXFJVU
1dhKtixJ8rPz7zFS/hSRswIyGew/7Jj6umBS/FSYTxjFfKaXKpBV9kaEKZK8L9js
Vzth
=JNss
-----END PGP PUBLIC KEY BLOCK-----

EOF

# install some packages we need
apt update
apt dist-upgrade -y -o Dpkg::Options::=--force-confnew
apt install --no-install-recommends -y \
    systemd \
    systemd-sysv \
    finalrd \
    libnss-extrausers \
    libpam-systemd \
    libpam-modules \
    libpam-pwquality \
    distro-info-data \
    tzdata \
    openssh-server \
    iproute2 \
    iptables \
    kmod \
    udev \
    sudo \
    less \
    dbus \
    dbus-user-session \
    vim-tiny \
    bash-completion \
    netcat-openbsd \
    iputils-ping \
    apparmor \
    netplan.io \
    ca-certificates \
    dosfstools \
    squashfs-tools \
    rfkill \
    wpasupplicant \
    cloud-init \
    dmsetup \
    cryptsetup \
    gnutls-bin \
    libopts25 \
    libp11-3 \
    opensc \
    p11-kit \
    p11-kit-modules \
    libengine-pkcs11-openssl \
    cracklib-runtime

case "$(dpkg --print-architecture)" in
    riscv64)
        ;;
    *)
        apt install --no-install-recommends -y gdbserver systemd-bootchart
        ;;
esac

# Install self-built console-conf and fake avahi-daemon
find /tmp -name '*.deb' -print0 | xargs -0 apt install -y
rm /tmp/*.deb

apt autoremove -y

case "$(dpkg --print-architecture)" in
    amd64|i386)
        apt install --no-install-recommends -y secureboot-db
        ;;
esac
